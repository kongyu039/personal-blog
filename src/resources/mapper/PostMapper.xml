<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pvt.example.mapper.PostMapper">
  <!--实体映射-->
  <resultMap id="base_result_map" type="pvt.example.pojo.entity.Post">
    <id property="id" column="id" />
    <!-- 关联Category N对1 -->
    <association property="category" column="category_id" select="selectCategoryById"
                 javaType="pvt.example.pojo.entity.Category" />
    <!-- 关联Tags N对N -->
    <collection property="tags" column="id" ofType="pvt.example.pojo.entity.Tag" select="selectTagsByPostId" />
  </resultMap>
  <!-- SQL Column -->
  <!-- @formatter:off -->
  <!--<sql id="base_columns">id, cover, title, summary, content, html_content, created_at, updated_at, is_top, is_del</sql>-->
  <!-- @formatter:on -->
  <!-- 查询 Category N对1 -->
  <select id="selectCategoryById" parameterType="Long" resultType="pvt.example.pojo.entity.Category">
    SELECT id, name, summary FROM categories WHERE id = #{category_id}
  </select>
  <!-- 查询 Tags N对N -->
  <select id="selectTagsByPostId" parameterType="Long" resultType="pvt.example.pojo.entity.Tag">
    SELECT id, name
    FROM tags
           JOIN tags_posts ON tags.id = tags_posts.tag_id
    WHERE tags_posts.post_id = #{postId}
  </select>
  <!-- 查询 List<Post> -->
  <select id="selectPost" resultMap="base_result_map" parameterType="pvt.example.pojo.query.PostQuery">
    SELECT id, cover, title, summary, content, html_content, created_at, updated_at, is_top, is_del,
    cp.category_id AS category_id
    FROM posts
    JOIN categories_posts cp ON id = cp.post_id
    WHERE is_del = 0
    <if test="title != null and title.length() > 0">
      AND title LIKE '%' || #{title} || '%'
    </if>
    <if test="summary != null and summary.length() > 0">
      AND summary LIKE '%' || #{summary} || '%'
    </if>
    <if test="categoryId != null">
      AND cp.category_id = #{categoryId}
    </if>
    <if test="tagIds != null and tagIds.size() > 0">
      AND EXISTS (
      SELECT 1 FROM tags_posts tp
      WHERE tp.post_id = posts.id
      AND tp.tag_id IN
      <foreach item="tagId" collection="tagIds" open="(" separator="," close=")">
        #{tagId}
      </foreach>
      )
    </if>
    <bind name="offset" value="(page-1) * limit" />
    <if test="page != null and limit != null">
      LIMIT #{limit} OFFSET #{offset}
    </if>
  </select>
  <!-- 统计数量 -->
  <select id="selectPostCount" resultType="java.lang.Integer">
    SELECT COUNT(*) FROM posts
    JOIN categories_posts cp ON id = cp.post_id
    WHERE is_del = 0
    <if test="title != null">
      AND title LIKE '%' || #{title} || '%'
    </if>
    <if test="summary != null">
      AND summary LIKE '%' || #{summary} || '%'
    </if>
    <if test="categoryId != null">
      AND cp.category_id = #{categoryId}
    </if>
    <if test="tagIds != null and tagIds.size() > 0">
      AND EXISTS (
      SELECT 1 FROM tags_posts tp
      WHERE tp.post_id = posts.id
      AND tp.tag_id IN
      <foreach item="tagId" collection="tagIds" open="(" separator="," close=")">
        #{tagId}
      </foreach>
      )
    </if>
  </select>
</mapper>